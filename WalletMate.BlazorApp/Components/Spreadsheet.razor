@using BlazorState
@using WalletMate.BlazorApp.Data
@using WalletMate.BlazorApp.Store.Spreadsheet
@inherits BlazorState.BlazorStateComponent
<Navbar Title="WalletMate">
    <Dropdown Show="@State.PeriodMenuVisible" @onclick="OnMenuClick" Label="Période">
        <DropdownItem Label="Ajouter une période" @onclick="CreatePeriodClick" />
    </Dropdown>
    <NavItem Label="Déconnecter" @onclick="OnDisconnectClick" />
</Navbar>
@if (State.AddPeriodPanelVisible) {
    <Animation Type="Animation.AnimationType.bounceIn">
        <ActionPanel TModel="NewPeriodModel" ActionModel="@NewPeriod" Title="Nouvelle période" OnSubmit="@SubmitCreatePeriodClick" OnCancel="@OnCancelAddPeriodClick">
            <ChildContent>
                <label>Année</label>
                <InputNumber @bind-Value=NewPeriod.Year class="form-control"></InputNumber>
                <label>Mois</label>
                <InputNumber @bind-Value=NewPeriod.Month class="form-control"></InputNumber>
            </ChildContent>
        </ActionPanel>
    </Animation>
}

<div class="container" style="margin-top:20px">
    @foreach (var periodId in State.Periods.Keys) {
        <PeriodPanel PeriodName="@periodId.ToPeriodName().ToString()"
                     Clicked="@( () => OnClicked(periodId) )"
                     Expanded="@State.Periods[periodId].Expand"
                     Operations="@State.Periods[periodId].Operations"
                     ClickAddSpending="@( () => AddSpendingClicked(periodId) )"
                      />
    }
</div>

@code {

    SpreadsheetState State => GetState<SpreadsheetState>();

    private void OnClicked(PeriodId periodId) => Mediator.Send(new SpreadsheetState.ToggleExpand(periodId));
    private void AddSpendingClicked(PeriodId periodId) => Mediator.Send(new SpreadsheetState.ShowAddOperationPanel(SpreadsheetState.ShowAddOperationPanel.OperationType.Spending));
    private void OnMenuClick() => Mediator.Send(new SpreadsheetState.ShowPeriodMenu());
    private void OnDisconnectClick() => Mediator.Send(new LoginState.Disconnect());
    private void OnCancelAddPeriodClick() => Mediator.Send(new SpreadsheetState.ShowAddPeriodPanel(false));
    private void CreatePeriodClick() => Mediator.Send(new SpreadsheetState.ShowAddPeriodPanel(true));
    private void SubmitCreatePeriodClick() => Mediator.Send(new SpreadsheetState.CreatePeriod(NewPeriod.Year, NewPeriod.Month));

    private NewPeriodModel NewPeriod { get; set; } = new NewPeriodModel();
}

